<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Catan Ranking</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #111113;
      --bg-tertiary: #18181b;
      --bg-card: #1c1c1f;
      --bg-hover: #242428;
      --border: #27272a;
      --border-light: #3f3f46;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent: #22c55e;
      --accent-glow: rgba(34, 197, 94, 0.15);
      --accent-secondary: #3b82f6;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gold: #fbbf24;
      --silver: #94a3b8;
      --bronze: #d97706;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    header { text-align: center; padding: 2rem 0 3rem; }
    .logo {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; }
    .tabs { display: flex; justify-content: center; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap; }
    .tab {
      padding: 0.7rem 1.3rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 100px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .tab:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .tab.active { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
    .card-title { font-size: 1.1rem; font-weight: 600; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
      padding: 0.8rem 1.5rem; font-family: inherit; font-size: 0.9rem; font-weight: 600;
      border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s ease;
    }
    .btn-primary { background: var(--accent); color: var(--bg-primary); }
    .btn-primary:hover { background: #16a34a; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-hover); }
    .btn-full { width: 100%; }
    .upload-area {
      border: 2px dashed var(--border-light);
      border-radius: 12px;
      padding: 2.5rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 1.5rem;
    }
    .upload-area:hover, .upload-area.dragover { border-color: var(--accent); background: var(--accent-glow); }
    .upload-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .upload-text { color: var(--text-secondary); margin-bottom: 0.25rem; }
    .upload-hint { font-size: 0.8rem; color: var(--text-muted); }
    #imageInput { display: none; }
    .preview-container { display: none; margin-bottom: 1.5rem; }
    .preview-container.active { display: block; }
    .preview-image { max-width: 100%; max-height: 350px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 1rem; object-fit: contain; }
    .config-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
    @media (max-width: 600px) { .config-grid { grid-template-columns: 1fr; } }
    .config-label { display: block; margin-bottom: 0.4rem; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
    input[type="text"], input[type="password"], input[type="number"], select {
      width: 100%; padding: 0.75rem 1rem; background: var(--bg-secondary); border: 1px solid var(--border);
      border-radius: 10px; color: var(--text-primary); font-size: 0.9rem; font-family: inherit;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); }
    .input-group { display: flex; gap: 0.5rem; }
    .loading { display: none; text-align: center; padding: 2rem; }
    .loading.active { display: block; }
    .spinner { border: 3px solid var(--border); border-top: 3px solid var(--accent); border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .result-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem; display: none; }
    .result-box.active { display: block; }
    .result-title { font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; }
    .error-box { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 10px; padding: 1rem; color: var(--danger); margin-top: 1rem; display: none; }
    .error-box.active { display: block; }
    .player-edit-row { display: grid; grid-template-columns: 36px 1fr 70px 36px; gap: 0.5rem; align-items: center; padding: 0.6rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.4rem; }
    .pos-badge { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: 700; font-size: 0.85rem; }
    .pos-1 { background: linear-gradient(135deg, var(--gold), #f59e0b); color: var(--bg-primary); }
    .pos-2 { background: linear-gradient(135deg, var(--silver), #64748b); color: var(--bg-primary); }
    .pos-3 { background: linear-gradient(135deg, var(--bronze), #b45309); color: var(--bg-primary); }
    .pos-default { background: var(--bg-secondary); color: var(--text-muted); }
    .player-edit-row select, .player-edit-row input { padding: 0.5rem; font-size: 0.85rem; }
    .remove-btn { padding: 0.5rem; background: transparent; border: none; color: var(--text-muted); cursor: pointer; border-radius: 6px; }
    .remove-btn:hover { background: rgba(239,68,68,0.15); color: var(--danger); }
    .add-btn { width: 100%; padding: 0.6rem; background: var(--bg-tertiary); border: 2px dashed var(--border); border-radius: 8px; color: var(--text-muted); cursor: pointer; margin-bottom: 1rem; }
    .add-btn:hover { border-color: var(--accent); color: var(--accent); }
    .victory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.4rem; margin-bottom: 1rem; }
    .victory-opt { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; padding: 0.6rem; background: var(--bg-tertiary); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .victory-opt.selected { background: var(--accent-glow); border-color: var(--accent); }
    .victory-opt:hover { border-color: var(--border-light); }
    .victory-emoji { font-size: 1.3rem; }
    .victory-text { font-size: 0.65rem; color: var(--text-secondary); }
    .form-section { margin-bottom: 1.5rem; }
    .form-label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.6rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .player-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.6rem; }
    .player-checkbox, .player-radio { position: relative; }
    .player-checkbox input, .player-radio input { position: absolute; opacity: 0; }
    .player-checkbox label, .player-radio label {
      display: flex; align-items: center; justify-content: center; padding: 0.8rem;
      background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 10px;
      cursor: pointer; font-weight: 500; transition: all 0.2s;
    }
    .player-checkbox input:checked + label { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }
    .player-checkbox label:hover, .player-radio label:hover { border-color: var(--border-light); background: var(--bg-tertiary); }
    .player-radio label { opacity: 0.5; pointer-events: none; }
    .player-radio.enabled label { opacity: 1; pointer-events: auto; }
    .player-radio.winner input:checked + label { background: rgba(34, 197, 94, 0.15); border-color: var(--accent); color: var(--accent); }
    .player-radio.loser input:checked + label { background: rgba(239, 68, 68, 0.15); border-color: var(--danger); color: var(--danger); }
    .ranking-table { width: 100%; border-collapse: collapse; }
    .ranking-table th { text-align: left; padding: 0.5rem 0.6rem; font-size: 0.7rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; border-bottom: 1px solid var(--border); }
    .ranking-table td { padding: 0.5rem 0.6rem; border-bottom: 1px solid var(--border); }
    .ranking-table tr:last-child td { border-bottom: none; }
    .ranking-table tbody tr:hover { background: var(--bg-hover); }
    .rank-badge { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 6px; font-weight: 700; font-size: 0.8rem; }
    .rank-1 { background: linear-gradient(135deg, var(--gold), #f59e0b); color: var(--bg-primary); }
    .rank-2 { background: linear-gradient(135deg, var(--silver), #64748b); color: var(--bg-primary); }
    .rank-3 { background: linear-gradient(135deg, var(--bronze), #b45309); color: var(--bg-primary); }
    .rank-default { background: var(--bg-tertiary); color: var(--text-secondary); }
    .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: var(--text-secondary); }
    .stat-value.highlight { color: var(--accent); font-weight: 600; font-size: 1.05rem; }
    .player-name { font-weight: 600; font-size: 1rem; }
    .top3-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; }
    .top3-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; }
    .top3-header { padding: 0.8rem 1.2rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border); font-weight: 600; font-size: 0.9rem; }
    .top3-list { padding: 0.4rem 0; }
    .top3-item { display: flex; align-items: center; justify-content: space-between; padding: 0.6rem 1.2rem; }
    .top3-item:not(:last-child) { border-bottom: 1px solid var(--border); }
    .top3-rank { display: flex; align-items: center; gap: 0.6rem; }
    .top3-position { width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem; border-radius: 5px; }
    .top3-position.gold { background: var(--gold); color: var(--bg-primary); }
    .top3-position.silver { background: var(--silver); color: var(--bg-primary); }
    .top3-position.bronze { background: var(--bronze); color: var(--bg-primary); }
    .top3-wins { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-muted); }
    .match-item { display: flex; align-items: center; padding: 0.8rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 0.5rem; gap: 0.8rem; }
    .match-number { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); min-width: 35px; }
    .match-players { flex: 1; display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .match-player { padding: 0.2rem 0.6rem; background: var(--bg-tertiary); border-radius: 100px; font-size: 0.8rem; }
    .match-player.winner { background: rgba(34, 197, 94, 0.15); color: var(--accent); font-weight: 500; }
    .match-player.loser { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    .match-delete { padding: 0.4rem; background: transparent; border: none; color: var(--text-muted); cursor: pointer; border-radius: 6px; }
    .match-delete:hover { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    .combination-section { margin-bottom: 1.5rem; }
    .combination-title { font-size: 0.95rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.8rem; padding-bottom: 0.4rem; border-bottom: 1px solid var(--border); }
    .combination-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.8rem; }
    .combination-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 0.8rem; }
    .combination-players { font-weight: 600; margin-bottom: 0.3rem; }
    .combination-total { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .combination-win-item { display: flex; justify-content: space-between; font-size: 0.85rem; }
    .combination-win-item .count { font-family: 'JetBrains Mono', monospace; color: var(--accent); }
    .vs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 0.8rem; }
    .vs-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; }
    .vs-title { font-weight: 600; text-align: center; margin-bottom: 0.8rem; }
    .vs-bar-row { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.4rem; }
    .vs-bar-name { min-width: 60px; font-size: 0.8rem; color: var(--text-secondary); }
    .vs-bar-container { flex: 1; height: 20px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; }
    .vs-bar { height: 100%; border-radius: 4px; }
    .vs-bar.player1 { background: var(--accent); }
    .vs-bar.player2 { background: var(--accent-secondary); }
    .vs-bar-value { min-width: 30px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--text-muted); text-align: right; }
    .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; padding: 0.8rem 1.2rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 0.6rem; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; z-index: 1001; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { border-color: var(--accent); }
    .toast.error { border-color: var(--danger); }
    .empty-state { text-align: center; padding: 2rem; color: var(--text-muted); }
    .empty-state-icon { font-size: 2.5rem; margin-bottom: 0.8rem; opacity: 0.5; }
    .data-controls { display: flex; gap: 0.8rem; flex-wrap: wrap; }
    .file-input-wrapper { position: relative; }
    .file-input-wrapper input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .logo { font-size: 2rem; }
      .tabs { gap: 0.3rem; }
      .tab { padding: 0.5rem 0.8rem; font-size: 0.75rem; }
      .card { padding: 1rem; }
      .player-grid { grid-template-columns: repeat(2, 1fr); }
      .victory-grid { grid-template-columns: repeat(2, 1fr); }
      .player-edit-row { grid-template-columns: 30px 1fr 60px 30px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 class="logo">CATAN</h1>
      <p class="subtitle">Sistema de Ranking</p>
    </header>

    <nav class="tabs">
      <button class="tab active" data-tab="ranking">üèÜ Ranking</button>
      <button class="tab" data-tab="imageUpload">üì∏ Nova Partida</button>
      <button class="tab" data-tab="top3">ü•á Top 3</button>
      <button class="tab" data-tab="history">üìã Hist√≥rico</button>
      <button class="tab" data-tab="combinations">üë• Combina√ß√µes</button>
      <button class="tab" data-tab="versus">‚öîÔ∏è 1v1</button>
    </nav>

    <!-- RANKING -->
    <section id="ranking" class="section active">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üèÜ Ranking Geral</h2>
        </div>
        <div style="overflow-x: auto;">
          <table class="ranking-table">
            <thead>
              <tr><th>#</th><th>Jogador</th><th>Pontos</th><th>Partidas</th><th>Vit√≥rias</th><th>Taxa</th><th>Vit√≥ria Favorita</th></tr>
            </thead>
            <tbody id="rankingBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- IMAGE UPLOAD -->
    <section id="imageUpload" class="section">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üì∏ An√°lise por Imagem</h2>
        </div>

        <div class="config-grid">
          <div>
            <label class="config-label">API Key OpenAI</label>
            <div class="input-group">
              <input type="password" id="apiKeyInput" placeholder="sk-proj-...">
              <button class="btn btn-secondary" onclick="toggleApiKey()" style="padding: 0.75rem;">üëÅÔ∏è</button>
            </div>
          </div>
          <div>
            <label class="config-label">URL Google Apps Script</label>
            <input type="text" id="scriptUrl" style="font-size: 0.75rem;">
          </div>
        </div>

        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">üé≤</div>
          <div class="upload-text">Clique, arraste ou <strong style="color: var(--accent);">Ctrl+V</strong></div>
          <div class="upload-hint">PNG, JPG at√© 5MB</div>
        </div>
        <input type="file" id="imageInput" accept="image/*">

        <div class="preview-container" id="previewContainer">
          <img id="previewImage" class="preview-image">
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="analyzeImage()">üîç Analisar</button>
            <button class="btn btn-secondary" onclick="clearImage()">üóëÔ∏è Limpar</button>
          </div>
        </div>

        <div class="loading" id="loading">
          <div class="spinner"></div>
          <p>Analisando imagem...</p>
        </div>

        <div class="error-box" id="errorBox"></div>

        <div class="result-box" id="resultBox">
          <div class="result-title">Resultado (edite se necess√°rio)</div>
          <div id="resultContent"></div>
          <button class="btn btn-primary btn-full" onclick="saveMatch()" style="margin-top: 1rem;">‚úÖ Salvar Partida</button>
        </div>

        <!-- MANUAL REGISTRATION (collapsible) -->
        <details style="margin-top: 1.5rem;">
          <summary style="cursor: pointer; color: var(--text-secondary); font-size: 0.9rem; padding: 0.5rem 0;">
            ‚úçÔ∏è Ou registre manualmente (sem foto)
          </summary>
          <div style="padding-top: 1rem;">
            <div class="form-section">
              <label class="form-label">Quem jogou?</label>
              <div class="player-grid" id="playersPlayed"></div>
            </div>
            <div class="form-section">
              <label class="form-label">Quem ganhou?</label>
              <div class="player-grid" id="winnerSelect"></div>
            </div>
            <div class="form-section">
              <label class="form-label">Quem ficou em √∫ltimo?</label>
              <div class="player-grid" id="loserSelect"></div>
            </div>
            <button class="btn btn-primary btn-full" id="registerBtn" disabled>‚úÖ Registrar</button>
          </div>
        </details>
      </div>
    </section>

    <!-- TOP 3 -->
    <section id="top3" class="section">
      <div class="top3-grid" id="top3Grid"></div>
      
      <!-- Ranking por n√∫mero de jogadores -->
      <h3 style="margin: 2rem 0 1rem; color: var(--text-secondary); font-size: 1rem;">üìä Ranking por N√∫mero de Jogadores</h3>
      <div class="top3-grid" id="rankingByPlayersGrid"></div>
    </section>

    <!-- HISTORY -->
    <section id="history" class="section">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìã Hist√≥rico</h2>
          <span id="matchCount" style="color: var(--text-muted); font-size: 0.85rem;">0 partidas</span>
        </div>
        <div id="matchHistory"></div>
      </div>
    </section>

    <!-- COMBINATIONS -->
    <section id="combinations" class="section">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üë• Combina√ß√µes</h2>
        </div>
        <div id="combinationsReport"></div>
      </div>
    </section>

    <!-- VERSUS -->
    <section id="versus" class="section">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">‚öîÔ∏è 1 vs 1</h2>
        </div>
        <div class="vs-grid" id="vsGrid"></div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">
    <span class="toast-icon">‚úì</span>
    <span id="toastMessage"></span>
  </div>

  <script>
    // CONFIG
    const PLAYERS = ["Rodrigo", "Tigas", "Dieg√£o", "Ciro", "Son", "Sacra"];
    const STORAGE_KEY = 'catan_matches';
    const API_KEY_STORAGE = 'openai_api_key';
    const SCRIPT_URL_STORAGE = 'google_script_url';
    const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzXWReIFrzl1DH6BY2TvYhVvQf5rqYDbvLM6Zijk7TNlw4LDL6aGJ5KsYmSKH3GNu8J/exec';

    const NAME_MAPPING = {
      'masterdscm': 'Dieg√£o', 'tigas': 'Tigas', 'digao4': 'Rodrigo',
      'myna7525': 'Ciro', 'myna': 'Ciro', 'son': 'Son', 'sacra': 'Sacra'
    };

    const WEIGHTS = { 3: 3, 4: 4, 5: 5, 6: 6 };
    const PENALTY = 0.15, K = 5;

    // STATE
    let matches = [];
    let currentImageData = null;
    let extractedData = null;
    let isLoading = true;

    // INIT
    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('apiKeyInput').value = localStorage.getItem(API_KEY_STORAGE) || '';
      document.getElementById('scriptUrl').value = localStorage.getItem(SCRIPT_URL_STORAGE) || DEFAULT_SCRIPT_URL;
      
      document.getElementById('apiKeyInput').addEventListener('change', e => localStorage.setItem(API_KEY_STORAGE, e.target.value));
      document.getElementById('scriptUrl').addEventListener('change', e => localStorage.setItem(SCRIPT_URL_STORAGE, e.target.value));
      
      document.addEventListener('paste', handlePaste);
      document.getElementById('uploadArea').addEventListener('click', () => document.getElementById('imageInput').click());
      document.getElementById('uploadArea').addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.classList.add('dragover'); });
      document.getElementById('uploadArea').addEventListener('dragleave', e => e.currentTarget.classList.remove('dragover'));
      document.getElementById('uploadArea').addEventListener('drop', e => { e.preventDefault(); e.currentTarget.classList.remove('dragover'); if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });
      document.getElementById('imageInput').addEventListener('change', e => { if(e.target.files[0]) handleFile(e.target.files[0]); });
      document.getElementById('registerBtn').addEventListener('click', registerManualMatch);

      setupTabs();
      renderPlayerSelection();
      
      // Carregar dados do CSV local
      await loadFromCSV();
    });

    // LOAD FROM LOCAL CSV
    async function loadFromCSV() {
      try {
        showLoadingState(true);
        const response = await fetch('dados.csv');
        if (!response.ok) throw new Error('CSV n√£o encontrado');
        
        const text = await response.text();
        const lines = text.split('\n').filter(l => l.trim());
        
        // Pular header
        matches = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = parseCSVLine(lines[i]);
          if (cols.length < 15) continue;
          
          // Estrutura: Data | J1 | Pts1 | J2 | Pts2 | J3 | Pts3 | J4 | Pts4 | J5 | Pts5 | J6 | Pts6 | Vencedor | √öltimo | Tipo Vit√≥ria
          const players = [];
          const points = [];
          
          for (let j = 0; j < 6; j++) {
            const name = cols[1 + j * 2]?.trim();
            const pts = cols[2 + j * 2]?.trim();
            if (name) {
              players.push(name);
              points.push(parseInt(pts) || 0);
            }
          }
          
          if (players.length >= 2) {
            matches.push({
              date: cols[0] || '',
              players,
              points,
              winner: cols[13]?.trim() || '',
              loser: cols[14]?.trim() || '',
              victory_type: cols[15]?.trim() || 'nenhum'
            });
          }
        }
        
        console.log(`${matches.length} partidas carregadas do CSV`);
        
      } catch (err) {
        console.error('Erro ao carregar CSV:', err);
        showToast('Erro ao carregar dados', 'error');
      } finally {
        isLoading = false;
        showLoadingState(false);
        renderAll();
      }
    }

    // Parse CSV line handling quoted values
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }

    function showLoadingState(loading) {
      const rankingBody = document.getElementById('rankingBody');
      if (loading) {
        rankingBody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">Carregando...</td></tr>';
      }
    }

    // PASTE HANDLER
    function handlePaste(e) {
      const items = e.clipboardData?.items;
      if (!items) return;
      for (const item of items) {
        if (item.type.startsWith('image/')) {
          e.preventDefault();
          handleFile(item.getAsFile());
          document.querySelector('[data-tab="imageUpload"]').click();
          showToast('Imagem colada!');
          break;
        }
      }
    }

    // UTILS
    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = msg;
      toast.querySelector('.toast-icon').textContent = type === 'error' ? '‚úï' : '‚úì';
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function mapPlayerName(username) {
      const clean = username.trim().toLowerCase();
      for (const [k, v] of Object.entries(NAME_MAPPING)) {
        if (clean.includes(k)) return v;
      }
      for (const p of PLAYERS) {
        if (clean.includes(p.toLowerCase())) return p;
      }
      return username.trim();
    }

    function toggleApiKey() {
      const input = document.getElementById('apiKeyInput');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    // TABS
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });
    }

    // IMAGE HANDLING
    function handleFile(file) {
      if (!file.type.startsWith('image/')) return showToast('Selecione uma imagem', 'error');
      if (file.size > 5 * 1024 * 1024) return showToast('M√°ximo 5MB', 'error');
      const reader = new FileReader();
      reader.onload = e => {
        currentImageData = e.target.result;
        document.getElementById('previewImage').src = currentImageData;
        document.getElementById('previewContainer').classList.add('active');
        document.getElementById('resultBox').classList.remove('active');
        document.getElementById('errorBox').classList.remove('active');
      };
      reader.readAsDataURL(file);
    }

    function clearImage() {
      currentImageData = null;
      extractedData = null;
      document.getElementById('previewContainer').classList.remove('active');
      document.getElementById('resultBox').classList.remove('active');
      document.getElementById('errorBox').classList.remove('active');
      document.getElementById('imageInput').value = '';
    }

    // API CALL - Simplified prompt (OCR only)
    async function analyzeImage() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (!apiKey) return showToast('Insira a API Key', 'error');
      if (!currentImageData) return showToast('Selecione uma imagem', 'error');

      localStorage.setItem(API_KEY_STORAGE, apiKey);
      
      const loading = document.getElementById('loading');
      const errorBox = document.getElementById('errorBox');
      const resultBox = document.getElementById('resultBox');
      
      loading.classList.add('active');
      errorBox.classList.remove('active');
      resultBox.classList.remove('active');

      try {
        const base64 = currentImageData.split(',')[1];
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
          body: JSON.stringify({
            model: 'gpt-4o',
            max_tokens: 1500,
            messages: [{
              role: 'user',
              content: [
                { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${base64}` } },
                { type: 'text', text: `Extraia os dados desta tabela de resultado do jogo Catan.

Para CADA jogador, extraia:
- username (nome/nick do jogador)
- total_points (pontua√ß√£o total)
- army_column (valor da pen√∫ltima coluna num√©rica - geralmente 0 ou 2)
- road_column (valor da √∫ltima coluna num√©rica - geralmente 0 ou 2)

Retorne APENAS JSON neste formato exato:
{
  "players": [
    {"username": "nome", "total_points": 10, "army_column": 2, "road_column": 0},
    {"username": "nome", "total_points": 8, "army_column": 0, "road_column": 0}
  ]
}

IMPORTANTE: Ordene por total_points (maior primeiro). Retorne SOMENTE o JSON.` }
              ]
            }]
          })
        });

        if (!response.ok) throw new Error((await response.json()).error?.message || 'Erro na API');
        
        const data = await response.json();
        const content = data.choices[0].message.content;
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('JSON n√£o encontrado na resposta');
        
        const parsed = JSON.parse(jsonMatch[0]);
        
        // INTERPRET VICTORY TYPE IN CODE (not AI)
        const winner = parsed.players[0];
        let victoryType = 'nenhum';
        if (winner) {
          const army = winner.army_column || 0;
          const road = winner.road_column || 0;
          if (army >= 2 && road >= 2) victoryType = 'ambos';
          else if (army >= 2) victoryType = 'maior_exercito';
          else if (road >= 2) victoryType = 'maior_estrada';
        }
        
        extractedData = {
          players: parsed.players.map(p => ({
            name: mapPlayerName(p.username),
            username: p.username,
            points: p.total_points
          })).sort((a, b) => b.points - a.points),
          victory_type: victoryType
        };

        renderEditableResults();
        resultBox.classList.add('active');
        showToast('Imagem analisada!');
        
      } catch (err) {
        console.error(err);
        errorBox.textContent = `Erro: ${err.message}`;
        errorBox.classList.add('active');
        showToast('Erro na an√°lise', 'error');
      } finally {
        loading.classList.remove('active');
      }
    }

    // EDITABLE RESULTS
    function renderEditableResults() {
      const container = document.getElementById('resultContent');
      const players = extractedData.players;
      
      let html = '';
      players.forEach((p, i) => {
        const posClass = i === 0 ? 'pos-1' : i === 1 ? 'pos-2' : i === 2 ? 'pos-3' : 'pos-default';
        html += `
          <div class="player-edit-row">
            <span class="pos-badge ${posClass}">${i + 1}¬∫</span>
            <select onchange="updatePlayer(${i}, 'name', this.value)">
              <option value="">-- Selecione --</option>
              ${PLAYERS.map(pl => `<option value="${pl}" ${p.name === pl ? 'selected' : ''}>${pl}</option>`).join('')}
              ${!PLAYERS.includes(p.name) && p.name ? `<option value="${p.name}" selected>${p.name}</option>` : ''}
            </select>
            <input type="number" value="${p.points}" min="0" max="20" onchange="updatePlayer(${i}, 'points', +this.value)">
            <button class="remove-btn" onclick="removePlayer(${i})">‚úï</button>
          </div>
        `;
      });
      
      html += `<button class="add-btn" onclick="addPlayer()">+ Adicionar Jogador</button>`;
      
      const vt = extractedData.victory_type;
      html += `
        <label class="form-label">Tipo de Vit√≥ria</label>
        <div class="victory-grid">
          <div class="victory-opt ${vt === 'nenhum' ? 'selected' : ''}" onclick="setVictory('nenhum')">
            <span class="victory-emoji">üèÜ</span><span class="victory-text">Normal</span>
          </div>
          <div class="victory-opt ${vt === 'maior_exercito' ? 'selected' : ''}" onclick="setVictory('maior_exercito')">
            <span class="victory-emoji">‚öîÔ∏è</span><span class="victory-text">Ex√©rcito</span>
          </div>
          <div class="victory-opt ${vt === 'maior_estrada' ? 'selected' : ''}" onclick="setVictory('maior_estrada')">
            <span class="victory-emoji">üõ£Ô∏è</span><span class="victory-text">Estrada</span>
          </div>
          <div class="victory-opt ${vt === 'ambos' ? 'selected' : ''}" onclick="setVictory('ambos')">
            <span class="victory-emoji">‚öîÔ∏èüõ£Ô∏è</span><span class="victory-text">Ambos</span>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function updatePlayer(i, field, value) {
      extractedData.players[i][field] = value;
      if (field === 'points') {
        extractedData.players.sort((a, b) => b.points - a.points);
        renderEditableResults();
      }
    }

    function removePlayer(i) {
      extractedData.players.splice(i, 1);
      renderEditableResults();
    }

    function addPlayer() {
      extractedData.players.push({ name: '', username: '', points: 0 });
      renderEditableResults();
    }

    function setVictory(type) {
      extractedData.victory_type = type;
      renderEditableResults();
    }

    // SAVE MATCH
    async function saveMatch() {
      if (!extractedData || extractedData.players.length < 3) return showToast('M√≠nimo 3 jogadores', 'error');
      if (extractedData.players.some(p => !p.name)) return showToast('Todos precisam de nome', 'error');

      const sorted = [...extractedData.players].sort((a, b) => b.points - a.points);
      const winner = sorted[0].name;
      const loser = sorted[sorted.length - 1].name;

      // Send to Google Sheets
      const scriptUrl = document.getElementById('scriptUrl').value.trim();
      if (scriptUrl) {
        try {
          await fetch(scriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
              date: new Date().toLocaleDateString('pt-BR'),
              players: sorted.map(p => ({ name: p.name, points: p.points })),
              winner, loser,
              victoryType: extractedData.victory_type
            })
          });
          showToast('Partida salva!');
          clearImage();
          
          // Recarregar dados da planilha ap√≥s pequeno delay (para dar tempo de salvar)
          setTimeout(() => loadFromSheet(), 1500);
          
        } catch (e) { 
          console.error('Sheets error:', e); 
          showToast('Erro ao salvar', 'error');
        }
      } else {
        showToast('Configure a URL do Google Apps Script', 'error');
      }
    }

    // MANUAL REGISTRATION
    function renderPlayerSelection() {
      const played = document.getElementById('playersPlayed');
      const winner = document.getElementById('winnerSelect');
      const loser = document.getElementById('loserSelect');

      played.innerHTML = PLAYERS.map(p => `
        <div class="player-checkbox">
          <input type="checkbox" id="played_${p}" name="played" value="${p}">
          <label for="played_${p}">${p}</label>
        </div>
      `).join('');

      winner.innerHTML = PLAYERS.map(p => `
        <div class="player-radio winner" id="winner_wrap_${p}">
          <input type="radio" id="winner_${p}" name="winner" value="${p}">
          <label for="winner_${p}">${p}</label>
        </div>
      `).join('');

      loser.innerHTML = PLAYERS.map(p => `
        <div class="player-radio loser" id="loser_wrap_${p}">
          <input type="radio" id="loser_${p}" name="loser" value="${p}">
          <label for="loser_${p}">${p}</label>
        </div>
      `).join('');

      document.querySelectorAll('input[name="played"]').forEach(cb => cb.addEventListener('change', updateManualSelection));
      document.querySelectorAll('input[name="winner"], input[name="loser"]').forEach(r => r.addEventListener('change', updateRegisterBtn));
    }

    function updateManualSelection() {
      const checked = [...document.querySelectorAll('input[name="played"]:checked')].map(c => c.value);
      PLAYERS.forEach(p => {
        const ww = document.getElementById(`winner_wrap_${p}`);
        const lw = document.getElementById(`loser_wrap_${p}`);
        const wi = document.getElementById(`winner_${p}`);
        const li = document.getElementById(`loser_${p}`);
        if (checked.includes(p)) {
          ww.classList.add('enabled');
          lw.classList.add('enabled');
        } else {
          ww.classList.remove('enabled');
          lw.classList.remove('enabled');
          wi.checked = false;
          li.checked = false;
        }
      });
      updateRegisterBtn();
    }

    function updateRegisterBtn() {
      const checked = document.querySelectorAll('input[name="played"]:checked').length;
      const winner = document.querySelector('input[name="winner"]:checked');
      const loser = document.querySelector('input[name="loser"]:checked');
      document.getElementById('registerBtn').disabled = !(checked >= 3 && winner && loser && winner.value !== loser.value);
    }

    async function registerManualMatch() {
      const players = [...document.querySelectorAll('input[name="played"]:checked')].map(c => c.value);
      const winner = document.querySelector('input[name="winner"]:checked')?.value;
      const loser = document.querySelector('input[name="loser"]:checked')?.value;
      if (players.length < 3 || !winner || !loser) return;

      // Send to Google Sheets
      const scriptUrl = document.getElementById('scriptUrl').value.trim();
      if (scriptUrl) {
        try {
          await fetch(scriptUrl, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
              date: new Date().toLocaleDateString('pt-BR'),
              players: players.map(p => ({ name: p, points: '' })),
              winner, loser,
              victoryType: 'nenhum'
            })
          });
          
          document.querySelectorAll('input[name="played"]').forEach(c => c.checked = false);
          document.querySelectorAll('input[name="winner"], input[name="loser"]').forEach(r => r.checked = false);
          updateManualSelection();
          showToast('Partida registrada!');
          
          // Recarregar dados da planilha
          setTimeout(() => loadFromSheet(), 1500);
          
        } catch (e) { 
          console.error('Sheets error:', e); 
          showToast('Erro ao salvar', 'error');
        }
      } else {
        showToast('Configure a URL do Google Apps Script', 'error');
      }
    }

    // CALCULATIONS
    function calculateRanking(list = matches) {
      const data = {};
      PLAYERS.forEach(p => data[p] = { played: 0, wins: 0, winPoints: 0, penalty: 0, points: 0, victoryTypes: {} });
      list.forEach(m => {
        const numPlayers = m.players.length;
        const w = WEIGHTS[numPlayers] || 4;
        
        m.players.forEach((p, index) => { 
          if (data[p]) { 
            data[p].played++; 
            
            // 1¬∫ lugar - pontua√ß√£o completa
            if (p === m.winner) {
              data[p].wins++;
              data[p].winPoints += w;
              const vt = m.victory_type || 'nenhum';
              data[p].victoryTypes[vt] = (data[p].victoryTypes[vt] || 0) + 1;
            }
            
            // 2¬∫ lugar - 20% (s√≥ em partidas de 4+)
            if (index === 1 && numPlayers >= 4) {
              data[p].winPoints += w * 0.20;
            }
            
            // 3¬∫ lugar - 10% (s√≥ em partidas de 6)
            if (index === 2 && numPlayers >= 6) {
              data[p].winPoints += w * 0.10;
            }
          } 
        });
        if (data[m.loser]) data[m.loser].penalty += PENALTY * w;
      });
      Object.keys(data).forEach(p => {
        if (data[p].played > 0) data[p].points = (data[p].winPoints - data[p].penalty) / (data[p].played + K);
        // Calcular tipo de vit√≥ria favorito
        const types = data[p].victoryTypes;
        let favType = 'nenhum';
        let maxCount = 0;
        for (const [type, count] of Object.entries(types)) {
          if (count > maxCount) {
            maxCount = count;
            favType = type;
          }
        }
        data[p].favVictory = favType;
        data[p].favVictoryCount = maxCount;
      });
      return Object.entries(data).map(([name, d]) => ({ name, ...d })).sort((a, b) => b.points - a.points);
    }

    function calculateTop3() {
      const byType = { 3: {}, 4: {}, 5: {}, 6: {} };
      PLAYERS.forEach(p => Object.keys(byType).forEach(t => byType[t][p] = 0));
      matches.forEach(m => { if (byType[m.players.length] && m.winner) byType[m.players.length][m.winner]++; });
      const result = {};
      Object.keys(byType).forEach(t => {
        result[t] = Object.entries(byType[t]).map(([name, wins]) => ({ name, wins })).sort((a, b) => b.wins - a.wins).slice(0, 3);
      });
      return result;
    }

    function calculateCombinations() {
      const combos = {};
      matches.forEach(m => {
        if (m.players.length === 3 || m.players.length === 4) {
          const key = [...m.players].sort().join(',');
          if (!combos[key]) combos[key] = { total: 0, wins: {} };
          combos[key].total++;
          combos[key].wins[m.winner] = (combos[key].wins[m.winner] || 0) + 1;
        }
      });
      return combos;
    }

    function calculateVersus() {
      const snaps = [];
      for (let i = 0; i < matches.length; i++) {
        const rank = calculateRanking(matches.slice(0, i + 1));
        const pts = {};
        rank.forEach(p => pts[p.name] = p.points);
        snaps.push(pts);
      }
      const vs = [];
      for (let i = 0; i < PLAYERS.length; i++) {
        for (let j = i + 1; j < PLAYERS.length; j++) {
          let p1Above = 0, p2Above = 0;
          snaps.forEach(s => {
            if ((s[PLAYERS[i]] || 0) > (s[PLAYERS[j]] || 0)) p1Above++;
            else if ((s[PLAYERS[j]] || 0) > (s[PLAYERS[i]] || 0)) p2Above++;
          });
          vs.push({ p1: PLAYERS[i], p2: PLAYERS[j], p1Above, p2Above });
        }
      }
      return vs;
    }

    // RENDERING
    const VICTORY_EMOJI = {
      'nenhum': 'üèÜ',
      'maior_exercito': '‚öîÔ∏è',
      'maior_estrada': 'üõ£Ô∏è',
      'ambos': 'üëë'
    };
    const VICTORY_LABEL = {
      'nenhum': 'Normal',
      'maior_exercito': 'Ex√©rcito',
      'maior_estrada': 'Estrada',
      'ambos': 'Ambos'
    };

    function renderRanking() {
      const ranking = calculateRanking();
      document.getElementById('rankingBody').innerHTML = ranking.map((p, i) => {
        const rc = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-default';
        const rate = p.played > 0 ? ((p.wins / p.played) * 100).toFixed(0) + '%' : '0%';
        const favEmoji = VICTORY_EMOJI[p.favVictory] || 'üèÜ';
        const favLabel = VICTORY_LABEL[p.favVictory] || 'Normal';
        const favDisplay = p.wins > 0 ? `${favEmoji} ${favLabel}` : '-';
        return `<tr>
          <td><span class="rank-badge ${rc}">${i + 1}</span></td>
          <td class="player-name">${p.name}</td>
          <td class="stat-value highlight">${p.points.toFixed(3)}</td>
          <td class="stat-value">${p.played}</td>
          <td class="stat-value">${p.wins}</td>
          <td class="stat-value">${rate}</td>
          <td class="stat-value">${favDisplay}</td>
        </tr>`;
      }).join('');
    }

    function renderTop3() {
      const top3 = calculateTop3();
      const titles = { 3: '3 Jogadores', 4: '4 Jogadores', 5: '5 Jogadores', 6: '6 Jogadores' };
      const pos = ['gold', 'silver', 'bronze'];
      document.getElementById('top3Grid').innerHTML = Object.entries(top3).map(([t, players]) => `
        <div class="top3-card">
          <div class="top3-header">${titles[t]}</div>
          <div class="top3-list">
            ${players.length ? players.map((p, i) => `
              <div class="top3-item">
                <div class="top3-rank">
                  <span class="top3-position ${pos[i]}">${i + 1}</span>
                  <span>${p.name}</span>
                </div>
                <span class="top3-wins">${p.wins} vit√≥rias</span>
              </div>
            `).join('') : '<div class="top3-item" style="color:var(--text-muted)">Sem dados</div>'}
          </div>
        </div>
      `).join('');
      
      // Render ranking por n√∫mero de jogadores
      renderRankingByPlayers();
    }

    function calculateRankingByPlayers(numPlayers) {
      const filtered = matches.filter(m => m.players.length === numPlayers);
      const data = {};
      PLAYERS.forEach(p => data[p] = { played: 0, wins: 0, winPoints: 0, penalty: 0, points: 0 });
      
      filtered.forEach(m => {
        const w = WEIGHTS[numPlayers] || 4;
        
        m.players.forEach((p, index) => { 
          if (data[p]) { 
            data[p].played++; 
            
            // 1¬∫ lugar
            if (p === m.winner) {
              data[p].wins++;
              data[p].winPoints += w;
            }
            
            // 2¬∫ lugar - 20% (s√≥ em partidas de 4+)
            if (index === 1 && numPlayers >= 4) {
              data[p].winPoints += w * 0.20;
            }
            
            // 3¬∫ lugar - 10% (s√≥ em partidas de 6)
            if (index === 2 && numPlayers >= 6) {
              data[p].winPoints += w * 0.10;
            }
          } 
        });
        if (data[m.loser]) data[m.loser].penalty += PENALTY * w;
      });
      
      Object.keys(data).forEach(p => {
        if (data[p].played > 0) data[p].points = (data[p].winPoints - data[p].penalty) / (data[p].played + K);
      });
      
      return Object.entries(data)
        .map(([name, d]) => ({ name, ...d }))
        .filter(p => p.played > 0)
        .sort((a, b) => b.points - a.points);
    }

    function renderRankingByPlayers() {
      const titles = { 3: '3 Jogadores', 4: '4 Jogadores', 5: '5 Jogadores', 6: '6 Jogadores' };
      const pos = ['gold', 'silver', 'bronze'];
      
      document.getElementById('rankingByPlayersGrid').innerHTML = [3, 4, 5, 6].map(num => {
        const ranking = calculateRankingByPlayers(num);
        return `
          <div class="top3-card">
            <div class="top3-header">${titles[num]}</div>
            <div class="top3-list">
              ${ranking.length ? ranking.slice(0, 6).map((p, i) => `
                <div class="top3-item">
                  <div class="top3-rank">
                    <span class="top3-position ${pos[i] || ''}" style="${i > 2 ? 'background:var(--bg-tertiary);color:var(--text-muted);' : ''}">${i + 1}</span>
                    <span>${p.name}</span>
                  </div>
                  <span class="top3-wins" style="font-family:'JetBrains Mono',monospace;">${p.points.toFixed(3)}</span>
                </div>
              `).join('') : '<div class="top3-item" style="color:var(--text-muted)">Sem dados</div>'}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderHistory() {
      document.getElementById('matchCount').textContent = `${matches.length} partida${matches.length !== 1 ? 's' : ''}`;
      const container = document.getElementById('matchHistory');
      if (!matches.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>Nenhuma partida</p></div>';
        return;
      }
      container.innerHTML = [...matches].reverse().map((m, ri) => {
        const i = matches.length - 1 - ri;
        return `<div class="match-item">
          <span class="match-number">#${i + 1}</span>
          <div class="match-players">
            ${m.players.map(p => `<span class="match-player ${p === m.winner ? 'winner' : p === m.loser ? 'loser' : ''}">${p}</span>`).join('')}
          </div>
          <button class="match-delete" onclick="deleteMatch(${i})">üóëÔ∏è</button>
        </div>`;
      }).join('');
    }

    function renderCombinations() {
      const combos = calculateCombinations();
      const c3 = Object.entries(combos).filter(([k]) => k.split(',').length === 3);
      const c4 = Object.entries(combos).filter(([k]) => k.split(',').length === 4);
      const container = document.getElementById('combinationsReport');
      
      if (!c3.length && !c4.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><p>Sem combina√ß√µes</p></div>';
        return;
      }

      let html = '';
      if (c3.length) {
        html += `<div class="combination-section"><h3 class="combination-title">3 Jogadores</h3><div class="combination-grid">
          ${c3.map(([k, d]) => {
            const ps = k.split(',');
            const sorted = Object.entries(d.wins).sort((a, b) => b[1] - a[1]);
            const noWin = ps.filter(p => !d.wins[p]);
            return `<div class="combination-card">
              <div class="combination-players">${ps.join(' ‚Ä¢ ')}</div>
              <div class="combination-total">${d.total} partida${d.total !== 1 ? 's' : ''}</div>
              ${sorted.map(([n, w]) => `<div class="combination-win-item"><span>${n}</span><span class="count">${w}</span></div>`).join('')}
              ${noWin.map(n => `<div class="combination-win-item"><span>${n}</span><span class="count" style="color:var(--text-muted)">0</span></div>`).join('')}
            </div>`;
          }).join('')}
        </div></div>`;
      }
      if (c4.length) {
        html += `<div class="combination-section"><h3 class="combination-title">4 Jogadores</h3><div class="combination-grid">
          ${c4.map(([k, d]) => {
            const ps = k.split(',');
            const sorted = Object.entries(d.wins).sort((a, b) => b[1] - a[1]);
            const noWin = ps.filter(p => !d.wins[p]);
            return `<div class="combination-card">
              <div class="combination-players">${ps.join(' ‚Ä¢ ')}</div>
              <div class="combination-total">${d.total} partida${d.total !== 1 ? 's' : ''}</div>
              ${sorted.map(([n, w]) => `<div class="combination-win-item"><span>${n}</span><span class="count">${w}</span></div>`).join('')}
              ${noWin.map(n => `<div class="combination-win-item"><span>${n}</span><span class="count" style="color:var(--text-muted)">0</span></div>`).join('')}
            </div>`;
          }).join('')}
        </div></div>`;
      }
      container.innerHTML = html;
    }

    function renderVersus() {
      const vs = calculateVersus();
      const container = document.getElementById('vsGrid');
      if (!matches.length) {
        container.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">‚öîÔ∏è</div><p>Sem dados</p></div>';
        return;
      }
      container.innerHTML = vs.map(({ p1, p2, p1Above, p2Above }) => {
        const total = p1Above + p2Above;
        const pct1 = total > 0 ? (p1Above / total) * 100 : 50;
        const pct2 = total > 0 ? (p2Above / total) * 100 : 50;
        return `<div class="vs-card">
          <div class="vs-title">${p1} vs ${p2}</div>
          <div class="vs-bar-row">
            <span class="vs-bar-name">${p1}</span>
            <div class="vs-bar-container"><div class="vs-bar player1" style="width:${pct1}%"></div></div>
            <span class="vs-bar-value">${p1Above}</span>
          </div>
          <div class="vs-bar-row">
            <span class="vs-bar-name">${p2}</span>
            <div class="vs-bar-container"><div class="vs-bar player2" style="width:${pct2}%"></div></div>
            <span class="vs-bar-value">${p2Above}</span>
          </div>
        </div>`;
      }).join('');
    }

    function renderAll() {
      renderRanking();
      renderTop3();
      renderHistory();
      renderCombinations();
      renderVersus();
    }

    // ACTIONS
    function deleteMatch(i) {
      if (confirm('Excluir esta partida?')) {
        matches.splice(i, 1);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(matches));
        renderAll();
        showToast('Partida exclu√≠da');
      }
    }

    function downloadCSV() {
      if (!matches.length) return showToast('Nenhuma partida', 'error');
      const header = 'Quem jogou,Quem ganhou,√öltimo\n';
      const rows = matches.map(m => `"${m.players.join(', ')}",${m.winner},${m.loser}`).join('\n');
      const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `catan-${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      showToast('CSV baixado!');
    }

    function importCSV(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const lines = ev.target.result.split('\n').filter(l => l.trim());
          const start = lines[0].toLowerCase().includes('jogou') || lines[0].toLowerCase().includes('jogador') ? 1 : 0;
          const newMatches = [];
          for (let i = start; i < lines.length; i++) {
            const match = lines[i].match(/^"?([^"]*)"?,([^,]+),([^,\r\n]+)/);
            if (match) {
              const players = match[1].split(',').map(p => p.trim());
              const winner = match[2].trim();
              const loser = match[3].trim();
              if (players.length >= 3 && winner && loser) newMatches.push({ players, winner, loser, timestamp: new Date().toISOString() });
            }
          }
          if (newMatches.length) {
            matches = newMatches;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(matches));
            renderAll();
            showToast(`${newMatches.length} partidas importadas!`);
          } else showToast('Nenhuma partida v√°lida', 'error');
        } catch (err) { showToast('Erro ao importar', 'error'); }
      };
      reader.readAsText(file);
      e.target.value = '';
    }
  </script>
</body>
</html>
